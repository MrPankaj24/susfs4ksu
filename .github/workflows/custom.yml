name: Build Hybrid ksu_susfs (Official GitLab Source)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Manually Clone from Official GitLab
    # We use 'git clone' because the official source is on GitLab, not GitHub.
    - name: Clone Source Code
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git .
        # Checkout the specific branch for Android 13 Kernel 5.15
        git checkout gki-android13-5.15

    # 2. Setup Android NDK
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r27

    # 3. Install Stealth Tool (UPX)
    - name: Install UPX
      run: |
        sudo apt-get update
        sudo apt-get install -y upx

    # 4. Compile the Binary
    - name: Compile ksu_susfs
      run: |
        cd ksu_module_susfs
        # Grant permission to the build script
        chmod +x build_ksu_susfs_tool.sh
        ./build_ksu_susfs_tool.sh

    # 5. Apply "Hybrid" Stealth (UPX Pack)
    - name: Create Hybrid (UPX Pack)
      run: |
        cd ksu_module_susfs/tools
        
        echo "Original Size:"
        ls -lh ksu_susfs_arm64
        
        # Pack the binary to make it invisible to Native Detector
        upx --best ksu_susfs_arm64 -o ksu_susfs
        
        echo "Hybrid Size:"
        ls -lh ksu_susfs

    # 6. Upload the Result
    - name: Upload Hybrid Binary
      uses: actions/upload-artifact@v4
      with:
        name: ksu_susfs_hybrid_final
        path: ksu_module_susfs/tools/ksu_susfs
