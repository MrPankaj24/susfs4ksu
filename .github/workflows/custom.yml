name: Build Hybrid ksu_susfs (Final Fix)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Clone the Source
    - name: Clone Source Code
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git .
        git checkout gki-android13-5.15

    # 2. Setup Android NDK
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r27

    # 3. Install UPX
    - name: Install UPX
      run: |
        sudo apt-get update
        sudo apt-get install -y upx

    # 4. Compile (Run script from Root)
    - name: Compile ksu_susfs
      run: |
        # The logs proved the script is in the root folder.
        # We simply give it permission and run it.
        chmod +x build_ksu_susfs_tool.sh
        ./build_ksu_susfs_tool.sh

    # 5. Apply Stealth (UPX Pack)
    - name: Create Hybrid (UPX Pack)
      run: |
        # The compiled file always lands here after the script runs
        cd ksu_module_susfs/tools
        
        echo "Original Size:"
        ls -lh ksu_susfs_arm64
        
        # Pack it to make it invisible to Native Detector
        upx --best ksu_susfs_arm64 -o ksu_susfs
        
        echo "Hybrid Size:"
        ls -lh ksu_susfs

    # 6. Upload
    - name: Upload Hybrid Binary
      uses: actions/upload-artifact@v4
      with:
        name: ksu_susfs_hybrid_final
        path: ksu_module_susfs/tools/ksu_susfs
